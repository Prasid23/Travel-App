<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Payment | EasyTrip</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2563eb;
      --primary-hover: #1d4ed8;
      --secondary-color: #f59e0b;
      --success-color: #10b981;
      --error-color: #ef4444;
      --text-color: #1e293b;
      --light-text: #64748b;
      --background: #f8fafc;
      --card-bg: #ffffff;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body, html {
      height: 100%;
      background-color: var(--background);
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-color: var(--background);
    }

    .top-section {
      background: linear-gradient(135deg, var(--primary-color), #3b82f6);
      color: white;
      padding: 20px;
      border-bottom-left-radius: 30px;
      border-bottom-right-radius: 30px;
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
      z-index: 1;
    }

    .top-section::before {
      content: '';
      position: absolute;
      top: -50px;
      right: -50px;
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      z-index: -1;
    }

    .top-section::after {
      content: '';
      position: absolute;
      bottom: -30px;
      left: -30px;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      z-index: -1;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .top-row i {
      font-size: 18px;
      cursor: pointer;
      transition: var(--transition);
    }

    .top-row i:hover {
      transform: scale(1.1);
    }

    .title {
      text-align: center;
      margin-top: 15px;
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .route {
      text-align: center;
      margin-top: 10px;
      line-height: 1.6;
    }

    .route strong {
      font-weight: 600;
      font-size: 16px;
    }

    .route i {
      margin: 0 10px;
      color: rgba(255, 255, 255, 0.8);
      transform: rotate(90deg);
      display: inline-block;
    }

    .bus-info {
      background-color: var(--card-bg);
      color: var(--text-color);
      border-radius: 12px;
      padding: 15px;
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-lg);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .bus-info::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--secondary-color);
    }

    .bus-info .left {
      display: flex;
      flex-direction: column;
      font-size: 13px;
      gap: 5px;
    }

    .bus-info .left strong {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-color);
    }

    .bus-info .left span {
      color: var(--light-text);
    }

    .bus-info .right {
      text-align: right;
      font-size: 13px;
    }

    .bus-info .right span:first-child {
      color: var(--light-text);
    }

    .bus-info .right strong {
      color: var(--secondary-color);
      font-size: 18px;
      font-weight: 700;
      display: block;
      margin: 3px 0;
    }

    .middle-section {
      flex: 1;
      padding: 25px 20px;
      background-color: var(--background);
      overflow-y: auto;
    }

    .payment-methods {
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      margin-bottom: 20px;
      overflow: hidden;
    }

    .payment-header {
      padding: 15px 20px;
      font-weight: 600;
      border-bottom: 1px solid #e2e8f0;
    }

    .payment-option {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 1px solid #e2e8f0;
    }

    .payment-option:last-child {
      border-bottom: none;
    }

    .payment-option:hover {
      background-color: #f8fafc;
    }

    .payment-option.active {
      background-color: #f0f7ff;
    }

    .payment-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background-color: #f1f5f9;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      color: var(--primary-color);
      font-size: 18px;
    }

    .payment-details {
      flex: 1;
    }

    .payment-title {
      font-weight: 500;
      margin-bottom: 3px;
    }

    .payment-description {
      font-size: 12px;
      color: var(--light-text);
    }

    .radio-btn {
      width: 20px;
      height: 20px;
      border: 2px solid #cbd5e1;
      border-radius: 50%;
      position: relative;
      transition: var(--transition);
    }

    .payment-option.active .radio-btn {
      border-color: var(--primary-color);
    }

    .radio-btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: var(--primary-color);
      opacity: 0;
      transition: var(--transition);
    }

    .payment-option.active .radio-btn::after {
      opacity: 1;
    }

    .payment-form {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow-sm);
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--text-color);
      font-weight: 500;
    }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: var(--transition);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .row {
      display: flex;
      gap: 15px;
    }

    .row .form-group {
      flex: 1;
    }

    .bottom-section {
      padding: 20px;
      background-color: var(--card-bg);
      box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
      border-top: 1px solid #e2e8f0;
    }

    .fare-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      font-size: 15px;
    }

    .fare-info .label {
      color: var(--light-text);
      font-size: 14px;
    }

    .fare-info .value {
      font-weight: 600;
      color: var(--text-color);
      margin-top: 5px;
      display: block;
    }

    .proceed-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(to right, var(--primary-color), var(--primary-hover));
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
    }

    .proceed-btn:hover {
      background: linear-gradient(to right, var(--primary-hover), #1e40af);
      box-shadow: 0 6px 8px rgba(37, 99, 235, 0.3);
      transform: translateY(-2px);
    }

    .proceed-btn:active {
      transform: translateY(0);
    }

    .proceed-btn:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Notification Styles */
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--card-bg);
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      transition: var(--transition);
      pointer-events: none;
    }

    .notification.show {
      opacity: 1;
      pointer-events: auto;
    }

    .notification.success {
      border-left: 4px solid var(--success-color);
    }

    .notification.error {
      border-left: 4px solid var(--error-color);
    }

    .notification-icon {
      margin-right: 15px;
      font-size: 20px;
    }

    .notification.success .notification-icon {
      color: var(--success-color);
    }

    .notification.error .notification-icon {
      color: var(--error-color);
    }

    .notification-content h4 {
      font-size: 16px;
      margin-bottom: 3px;
    }

    .notification-content p {
      font-size: 14px;
      color: var(--light-text);
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      opacity: 0;
      pointer-events: none;
      transition: var(--transition);
    }

    .modal-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    .modal {
      background-color: var(--card-bg);
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      box-shadow: var(--shadow-lg);
      transform: translateY(20px);
      transition: var(--transition);
    }

    .modal-overlay.show .modal {
      transform: translateY(0);
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #e2e8f0;
      text-align: center;
      position: relative;
    }

    .modal-header h3 {
      font-size: 18px;
      color: var(--text-color);
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: var(--light-text);
    }

    .modal-body {
      padding: 20px;
      text-align: center;
    }

    .modal-icon {
      font-size: 50px;
      color: var(--success-color);
      margin-bottom: 15px;
    }

    .modal-body p {
      margin-bottom: 20px;
      color: var(--text-color);
    }

    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: center;
    }

    .modal-btn {
      padding: 10px 20px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
    }

    .modal-btn:hover {
      background-color: var(--primary-hover);
    }

    /* Animation classes */
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="container">

    <div class="top-section fade-in">
      <div class="top-row">
        <i class="fas fa-arrow-left" id="backBtn"></i>
        <span id="routeDisplay">Loading...</span>
      </div>
      <div class="title">Complete Your Payment</div>
      <div class="route" id="dateTimeDisplay">
        <strong id="journeyDate">Loading...</strong> | <strong id="departureTime">Loading...</strong>
      </div>
      <div class="bus-info">
        <div class="left">
          <span id="busName">Loading...</span>
          <span id="busDetails">Loading...</span>
        </div>
        <div class="right">
          <span>Total Fare</span>
          <strong id="totalFare">Loading...</strong>
        </div>
      </div>
    </div>

    <div class="middle-section">
      <div class="payment-methods fade-in">
        <div class="payment-header">
          Select Payment Method
        </div>
        <div class="payment-option active" data-method="card">
          <div class="payment-icon">
            <i class="far fa-credit-card"></i>
          </div>
          <div class="payment-details">
            <div class="payment-title">Credit/Debit Card</div>
            <div class="payment-description">Pay using Visa, Mastercard, or other cards</div>
          </div>
          <div class="radio-btn"></div>
        </div>
        <div class="payment-option" data-method="wallet">
          <div class="payment-icon">
            <i class="fas fa-wallet"></i>
          </div>
          <div class="payment-details">
            <div class="payment-title">E-Wallet</div>
            <div class="payment-description">Pay using eSewa, Khalti, or other wallets</div>
          </div>
          <div class="radio-btn"></div>
        </div>
        <div class="payment-option" data-method="cod">
          <div class="payment-icon">
            <i class="fas fa-money-bill-wave"></i>
          </div>
          <div class="payment-details">
            <div class="payment-title">Cash on Board</div>
            <div class="payment-description">Pay cash when you board the bus</div>
          </div>
          <div class="radio-btn"></div>
        </div>
      </div>

      <div class="payment-form fade-in" style="animation-delay: 0.1s;">
        <div class="form-group">
          <label for="cardNumber">Card Number</label>
          <input type="text" id="cardNumber" class="form-control" placeholder="1234 5678 9012 3456">
        </div>
        <div class="row">
          <div class="form-group">
            <label for="expiry">Expiry Date</label>
            <input type="text" id="expiry" class="form-control" placeholder="MM/YY">
          </div>
          <div class="form-group">
            <label for="cvv">CVV</label>
            <input type="text" id="cvv" class="form-control" placeholder="123">
          </div>
        </div>
        <div class="form-group">
          <label for="name">Cardholder Name</label>
          <input type="text" id="name" class="form-control" placeholder="Smita Dhungel">
        </div>
      </div>
    </div>

    <div class="bottom-section fade-in" style="animation-delay: 0.2s;">
      <div class="fare-info">
        <div>
          <span class="label">Base Fare (2 seats)</span>
          <span class="value">₹ 1,200</span>
        </div>
        <div>
          <span class="label">Service Fee</span>
          <span class="value">₹ 150</span>
        </div>
      </div>
      <button class="proceed-btn" id="payBtn">
        <i class="fas fa-lock" style="margin-right: 8px;"></i> Pay ₹ 1,350
      </button>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
      <div class="notification-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="notification-content">
        <h4>Payment Successful</h4>
        <p>Your booking has been confirmed!</p>
      </div>
    </div>

    <!-- Success Modal -->
    <div class="modal-overlay" id="successModal">
      <div class="modal">
        <div class="modal-header">
          <h3>Booking Confirmed!</h3>
          <button class="modal-close" id="closeModal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="modal-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <p>Your payment was successful and your seats are now reserved.</p>
          <p><strong>Booking ID: <span id="bookingIdDisplay">STB-0000</span></strong></p>
        </div>
        <div class="modal-footer">
          <button class="modal-btn" id="detailsPage">Details Page</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // Parse URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const bookingId = urlParams.get('booking_id');
    const amount = urlParams.get('amount');
    
    // Function to show error notification
    function showError(message) {
      const notification = document.getElementById('notification');
      notification.classList.remove('success');
      notification.classList.add('error', 'show');
      document.querySelector('#notification h4').textContent = 'Error';
      document.querySelector('#notification p').textContent = message;
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 5000);
    }
    
    // Function to format date
    function formatDate(dateString) {
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      return new Date(dateString).toLocaleDateString('en-US', options);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      // Back button functionality
      document.getElementById('backBtn').addEventListener('click', function() {
        window.history.back();
      });
      
      // Fetch booking details
      if (bookingId) {
        fetch(`../php/get_bus_booking_details.php?booking_id=${bookingId}`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const booking = data.data;
              
              // Update UI with booking details
              document.getElementById('routeDisplay').textContent = booking.route;
              document.getElementById('journeyDate').textContent = formatDate(booking.journey_date);
              document.getElementById('departureTime').textContent = booking.departure_time;
              document.getElementById('busName').textContent = booking.bus_name;
              document.getElementById('busDetails').textContent = 
                `${booking.bus_type} | Seats: ${booking.seat_numbers}`;
              document.getElementById('totalFare').textContent = `Rs. ${booking.total_amount}`;
              
              // Update pay button text
              document.getElementById('payBtn').innerHTML = 
                `<i class="fas fa-lock" style="margin-right: 8px;"></i> Pay Rs. ${booking.total_amount}`;
                
              // Update fare breakdown
              const fareInfo = document.querySelector('.fare-info');
              fareInfo.innerHTML = `
                <div>
                  <span class="label">Base Fare (${booking.num_seats} seats)</span>
                  <span class="value">Rs. ${booking.price_per_seat * booking.num_seats}</span>
                </div>
                <div>
                  <span class="label">Service Fee</span>
                  <span class="value">Rs. 0</span>
                </div>
              `;
            } else {
              showError('Failed to load booking details. Please try again.');
            }
          })
          .catch(error => {
            console.error('Error fetching booking details:', error);
            showError('Failed to load booking details. Please try again.');
          });
      } else if (amount) {
        // If we only have amount but no booking ID
        document.getElementById('totalFare').textContent = `Rs. ${amount}`;
        document.getElementById('payBtn').innerHTML = 
          `<i class="fas fa-lock" style="margin-right: 8px;"></i> Pay Rs. ${amount}`;
      } else {
        showError('Missing booking information. Please go back and try again.');
      }

      // Payment method selection
      const paymentOptions = document.querySelectorAll('.payment-option');
      paymentOptions.forEach(option => {
        option.addEventListener('click', function() {
          paymentOptions.forEach(opt => opt.classList.remove('active'));
          this.classList.add('active');
          
          // Show/hide payment form based on selection
          const paymentForm = document.querySelector('.payment-form');
          if (this.dataset.method === 'cod') {
            paymentForm.style.display = 'none';
          } else {
            paymentForm.style.display = 'block';
          }
        });
      });

      // Payment button functionality
      const payBtn = document.getElementById('payBtn');
      const notification = document.getElementById('notification');
      const successModal = document.getElementById('successModal');

      payBtn.addEventListener('click', function() {
        // Get payment method
        let paymentMethod = 'card';
        document.querySelectorAll('.payment-option').forEach(option => {
          if (option.classList.contains('active')) {
            paymentMethod = option.dataset.method;
          }
        });
        
        // Get booking ID from URL
        const bookingId = urlParams.get('booking_id');
        if (!bookingId) {
          showError('Missing booking information. Please try again.');
          return;
        }
        
        // Disable button and show processing state
        payBtn.disabled = true;
        payBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i> Processing...';
        
        // In a real application, this would make an API call to process payment
        // For this demo, we'll simulate a successful payment after a delay
        setTimeout(() => {
          // Show success notification
          notification.classList.add('success', 'show');
          document.querySelector('#notification h4').textContent = 'Payment Successful';
          document.querySelector('#notification p').textContent = 'Your booking has been confirmed!';
          
          // Update booking status to 'confirmed' via API call
          fetch('../php/update_booking_status.php', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              booking_id: bookingId,
              status: 'confirmed',
              payment_method: paymentMethod
            })
          })
          .then(response => response.json())
          .then(data => {
            console.log('Booking status updated:', data);
            
            // Hide notification after 3 seconds
            setTimeout(() => {
              notification.classList.remove('show');
              
              // Show success modal after notification hides
              setTimeout(() => {
                // Update booking ID in modal
                document.querySelector('#bookingIdDisplay').textContent = `STB-${bookingId}`;
                successModal.classList.add('show');
              }, 300);
            }, 3000);
          })
          .catch(error => {
            console.error('Error updating booking status:', error);
            showError('Payment was successful, but there was an issue updating your booking. Please contact support.');
          });
          
          // Reset button state
          setTimeout(() => {
            payBtn.disabled = false;
            const amountText = document.getElementById('totalFare').textContent;
            payBtn.innerHTML = `<i class="fas fa-lock" style="margin-right: 8px;"></i> Pay ${amountText}`;
          }, 3500);
        }, 2000);
      });

      // Close modal
      document.getElementById('closeModal').addEventListener('click', function() {
        successModal.classList.remove('show');
      });

      // Details Page button - redirect to booking details page
      document.getElementById('detailsPage').addEventListener('click', function() {
        window.location.href = `booking-details.html?booking_id=${bookingId}`;
      });

      // Close modal when clicking outside
      successModal.addEventListener('click', function(e) {
        if (e.target === successModal) {
          successModal.classList.remove('show');
        }
      });
    });
  </script>
</body>
</html>